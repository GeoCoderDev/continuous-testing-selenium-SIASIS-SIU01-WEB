# Archivo: .github/workflows/test-automation.yml
name: ðŸš€ SIASIS Test Automation

on:
  repository_dispatch:
    types: [test-siu01-web]

permissions:
  contents: write
  actions: read
  checks: write
  pull-requests: write
  statuses: write

jobs:
  test-automation:
    name: ðŸ§ª Execute SIASIS Tests
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“ Checkout Repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: â˜• Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: "17"
          cache: maven

      - name: ðŸ”§ Setup Chrome Browser
        uses: browser-actions/setup-chrome@v1
        with:
          chrome-version: stable

      - name: ðŸ“‹ Parse Input Parameters
        id: params
        run: |
          echo "ðŸ” Parsing webhook payload..."
          TAGS="${{ github.event.client_payload.tags }}"
          ENVIRONMENT="${{ github.event.client_payload.environment }}"
          REPORT_NAME="${{ github.event.client_payload.report_name }}"
          BROWSER="${{ github.event.client_payload.browser }}"
          PARALLEL="${{ github.event.client_payload.parallel }}"

          TAGS=${TAGS:-"@Login"}
          ENVIRONMENT=${ENVIRONMENT:-"D"}
          REPORT_NAME=${REPORT_NAME:-"$(date +%Y%m%d_%H%M%S)_${ENVIRONMENT}"}
          BROWSER=${BROWSER:-"chrome"}
          PARALLEL=${PARALLEL:-"false"}

          if [ "$ENVIRONMENT" = "D" ]; then
            ENV_NAME="dev"
            ENV_DISPLAY="ðŸ› ï¸ DESARROLLO"
          elif [ "$ENVIRONMENT" = "C" ]; then
            ENV_NAME="cert"
            ENV_DISPLAY="ðŸŽ¯ CERTIFICACIÃ“N"
          else
            ENV_NAME="dev"
            ENV_DISPLAY="ðŸ› ï¸ DESARROLLO (default)"
            ENVIRONMENT="D"
          fi

          echo "tags=$TAGS" >> $GITHUB_OUTPUT
          echo "environment=$ENVIRONMENT" >> $GITHUB_OUTPUT
          echo "env_name=$ENV_NAME" >> $GITHUB_OUTPUT
          echo "env_display=$ENV_DISPLAY" >> $GITHUB_OUTPUT
          echo "report_name=$REPORT_NAME" >> $GITHUB_OUTPUT
          echo "browser=$BROWSER" >> $GITHUB_OUTPUT
          echo "parallel=$PARALLEL" >> $GITHUB_OUTPUT

      - name: ðŸ” Setup Environment Variables
        run: |
          echo "ðŸ” Configurando variables de entorno para ${{ steps.params.outputs.env_display }}"
          echo "ENTORNO=${{ steps.params.outputs.environment }}" >> $GITHUB_ENV
          echo "BROWSER=${{ steps.params.outputs.browser }}" >> $GITHUB_ENV

          echo "CI_HEADLESS_MODE=true" >> $GITHUB_ENV

          if [ "${{ steps.params.outputs.environment }}" = "D" ]; then
            # Entorno DEV
            echo "DIRECTIVO_USERNAME_DEV=${{ secrets.DIRECTIVO_USERNAME_DEV }}" >> $GITHUB_ENV
            echo "DIRECTIVO_PASSWORD_DEV=${{ secrets.DIRECTIVO_PASSWORD_DEV }}" >> $GITHUB_ENV
            echo "AUXILIAR_USERNAME_DEV=${{ secrets.AUXILIAR_USERNAME_DEV }}" >> $GITHUB_ENV
            echo "AUXILIAR_PASSWORD_DEV=${{ secrets.AUXILIAR_PASSWORD_DEV }}" >> $GITHUB_ENV
            echo "PROFESOR_PRIMARIA_USERNAME_DEV=${{ secrets.PROFESOR_PRIMARIA_USERNAME_DEV }}" >> $GITHUB_ENV
            echo "PROFESOR_PRIMARIA_PASSWORD_DEV=${{ secrets.PROFESOR_PRIMARIA_PASSWORD_DEV }}" >> $GITHUB_ENV
            echo "PROFESOR_SECUNDARIA_USERNAME_DEV=${{ secrets.PROFESOR_SECUNDARIA_USERNAME_DEV }}" >> $GITHUB_ENV
            echo "PROFESOR_SECUNDARIA_PASSWORD_DEV=${{ secrets.PROFESOR_SECUNDARIA_PASSWORD_DEV }}" >> $GITHUB_ENV
            echo "TUTOR_SECUNDARIA_USERNAME_DEV=${{ secrets.TUTOR_SECUNDARIA_USERNAME_DEV }}" >> $GITHUB_ENV
            echo "TUTOR_SECUNDARIA_PASSWORD_DEV=${{ secrets.TUTOR_SECUNDARIA_PASSWORD_DEV }}" >> $GITHUB_ENV
            echo "PERSONAL_ADMINISTRATIVO_USERNAME_DEV=${{ secrets.PERSONAL_ADMINISTRATIVO_USERNAME_DEV }}" >> $GITHUB_ENV
            echo "PERSONAL_ADMINISTRATIVO_PASSWORD_DEV=${{ secrets.PERSONAL_ADMINISTRATIVO_PASSWORD_DEV }}" >> $GITHUB_ENV
            echo "RESPONSABLE_USERNAME_DEV=${{ secrets.RESPONSABLE_USERNAME_DEV }}" >> $GITHUB_ENV
            echo "RESPONSABLE_PASSWORD_DEV=${{ secrets.RESPONSABLE_PASSWORD_DEV }}" >> $GITHUB_ENV
          else
            # Entorno CERT
            echo "DIRECTIVO_USERNAME_CERT=${{ secrets.DIRECTIVO_USERNAME_CERT }}" >> $GITHUB_ENV
            echo "DIRECTIVO_PASSWORD_CERT=${{ secrets.DIRECTIVO_PASSWORD_CERT }}" >> $GITHUB_ENV
            echo "AUXILIAR_USERNAME_CERT=${{ secrets.AUXILIAR_USERNAME_CERT }}" >> $GITHUB_ENV
            echo "AUXILIAR_PASSWORD_CERT=${{ secrets.AUXILIAR_PASSWORD_CERT }}" >> $GITHUB_ENV
            echo "PROFESOR_PRIMARIA_USERNAME_CERT=${{ secrets.PROFESOR_PRIMARIA_USERNAME_CERT }}" >> $GITHUB_ENV
            echo "PROFESOR_PRIMARIA_PASSWORD_CERT=${{ secrets.PROFESOR_PRIMARIA_PASSWORD_CERT }}" >> $GITHUB_ENV
            echo "PROFESOR_SECUNDARIA_USERNAME_CERT=${{ secrets.PROFESOR_SECUNDARIA_USERNAME_CERT }}" >> $GITHUB_ENV
            echo "PROFESOR_SECUNDARIA_PASSWORD_CERT=${{ secrets.PROFESOR_SECUNDARIA_PASSWORD_CERT }}" >> $GITHUB_ENV
            echo "TUTOR_SECUNDARIA_USERNAME_CERT=${{ secrets.TUTOR_SECUNDARIA_USERNAME_CERT }}" >> $GITHUB_ENV
            echo "TUTOR_SECUNDARIA_PASSWORD_CERT=${{ secrets.TUTOR_SECUNDARIA_PASSWORD_CERT }}" >> $GITHUB_ENV
            echo "PERSONAL_ADMINISTRATIVO_USERNAME_CERT=${{ secrets.PERSONAL_ADMINISTRATIVO_USERNAME_CERT }}" >> $GITHUB_ENV
            echo "PERSONAL_ADMINISTRATIVO_PASSWORD_CERT=${{ secrets.PERSONAL_ADMINISTRATIVO_PASSWORD_CERT }}" >> $GITHUB_ENV
            echo "RESPONSABLE_USERNAME_CERT=${{ secrets.RESPONSABLE_USERNAME_CERT }}" >> $GITHUB_ENV
            echo "RESPONSABLE_PASSWORD_CERT=${{ secrets.RESPONSABLE_PASSWORD_CERT }}" >> $GITHUB_ENV
          fi

          echo "âœ… Variables de entorno configuradas"

      - name: ðŸ§ª Execute Tests
        id: tests
        run: |
          echo "ðŸš€ Ejecutando tests en ${{ steps.params.outputs.env_display }}"

          cat > .env << EOF
          ENTORNO="${{ steps.params.outputs.environment }}"
          EOF

          set +e
          mvn clean verify -Dcucumber.filter.tags="${{ steps.params.outputs.tags }}" -B
          TEST_EXIT_CODE=$?
          set -e

          echo "test_exit_code=$TEST_EXIT_CODE" >> $GITHUB_OUTPUT

          if [ -d "reports/${{ steps.params.outputs.env_name }}" ]; then
            echo "reports_generated=true" >> $GITHUB_OUTPUT
            echo "âœ… Reportes generados en reports/${{ steps.params.outputs.env_name }}/"
          else
            echo "reports_generated=false" >> $GITHUB_OUTPUT
            echo "âŒ No se generaron reportes"
          fi

      - name: ðŸ”’ Create Secure Metadata
        if: always()
        run: |
          mkdir -p reports/${{ steps.params.outputs.env_name }}

          cat > reports/${{ steps.params.outputs.env_name }}/test-metadata.txt << EOF
          # SIASIS Test Execution Metadata (GitHub Actions)

          Execution Parameters:

            - Entorno: ${{ steps.params.outputs.env_name }}
            - Tags: ${{ steps.params.outputs.tags }}
            - Browser: ${{ steps.params.outputs.browser }}
            - Paralelo: ${{ steps.params.outputs.parallel }}
            - Report Name: ${{ steps.params.outputs.report_name }}

            - Repository: ${{ github.repository }}
            - Run ID: ${{ github.run_id }}
            - Actor: ${{ github.actor }}

            - Test Exit Code: ${{ steps.tests.outputs.test_exit_code }}
            - Reports Generated: ${{ steps.tests.outputs.reports_generated }}

            ðŸ” Created by SIASIS Test Automation
          EOF

      - name: ðŸ“Š Upload Test Reports (Backup)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-reports-${{ steps.params.outputs.report_name }}
          path: |
            target/cucumber-reports/
            target/surefire-reports/
            reports/
            index.html
          retention-days: 30

      - name: ðŸ“ˆ Publish Test Results
        if: always()
        uses: dorny/test-reporter@v1
        with:
          name: ðŸ§ª Tests Results (${{ steps.params.outputs.env_display }})
          path: target/surefire-reports/*.xml
          reporter: java-junit
          fail-on-error: false

      - name: ðŸš€ Commit and Push Reports to test-results Branch
        if: steps.tests.outputs.reports_generated == 'true'
        run: |
          echo "ðŸš€ Preparando commit de reportes a la rama test-results"

          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action - SIASIS Tests"

          echo "ðŸ” Verificando rama test-results..."

          git fetch origin || true

          # âš¡ Limpiar archivos no rastreados para evitar error al cambiar de rama
          git clean -f -d

          if git ls-remote --exit-code --heads origin test-results > /dev/null 2>&1; then
            echo "âœ… Rama test-results existe, haciendo checkout..."
            git checkout test-results
            git pull origin test-results
          else
            echo "ðŸ†• Creando nueva rama test-results..."
            git checkout --orphan test-results
            git rm -rf . --quiet || true
            cat > README.md << EOF
          # ðŸ“Š SIASIS Test Results

          Esta rama contiene los reportes automatizados de testing para el sistema SIASIS.

          - ðŸŒ Ver Reportes en GitHub Pages

            https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/

            Ãšltima actualizaciÃ³n: $(date -u '+%Y-%m-%d %H:%M:%S UTC')

          EOF
            git add README.md
            git commit -m "ðŸ†• Inicializar rama test-results"
          fi

          git status

          git add reports/
          git add index.html

          if git diff --staged --quiet; then
            echo "âš ï¸ No hay cambios en los reportes para commitear"
          else
            COMMIT_MSG="ðŸ“Š Auto-update test reports - ${{ steps.params.outputs.env_display }}
            
            ðŸ·ï¸ Tags: ${{ steps.params.outputs.tags }}
            ðŸŽ¯ Environment: ${{ steps.params.outputs.env_name }}
            ðŸ“ Report: ${{ steps.params.outputs.report_name }}
            ðŸŒ Browser: ${{ steps.params.outputs.browser }}
            âš¡ Parallel: ${{ steps.params.outputs.parallel }}
            
            ðŸ¤– Generated by GitHub Actions
            ðŸ“‹ Run: ${{ github.run_id }}
            ðŸ‘¤ Triggered by: ${{ github.actor }}
            ðŸ• Time: $(date -u '+%Y-%m-%d %H:%M:%S UTC')
            
            ${{ steps.tests.outputs.test_exit_code == '0' && 'âœ… Tests: PASSED' || 'âŒ Tests: FAILED' }}"
            
            git commit -m "$COMMIT_MSG"
            
            echo "ðŸš€ Pushing reportes a la rama test-results..."
            git push origin test-results
            echo "âœ… Reportes pusheados exitosamente a la rama test-results"
            echo "ðŸŒ GitHub Pages se actualizarÃ¡ en unos minutos"
            echo "ðŸ“– Dashboard: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/"
          fi

      - name: ðŸ“‹ Test Summary
        if: always()
        run: |
          echo "## ðŸ§ª Resumen de EjecuciÃ³n de Tests" >> $GITHUB_STEP_SUMMARY

          echo "| ParÃ¡metro | Valor |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸŒ Entorno | ${{ steps.params.outputs.env_display }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ·ï¸ Tags | \`${{ steps.params.outputs.tags }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ“ Nombre Reporte | ${{ steps.params.outputs.report_name }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸŒ Browser | ${{ steps.params.outputs.browser }} |" >> $GITHUB_STEP_SUMMARY
          echo "| âš¡ Paralelo | ${{ steps.params.outputs.parallel }} |" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.tests.outputs.test_exit_code }}" = "0" ]; then
            echo "### âœ… Resultado: Ã‰XITO" >> $GITHUB_STEP_SUMMARY
          else
            echo "### âŒ Resultado: FALLÃ“" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ steps.tests.outputs.reports_generated }}" = "true" ]; then
            echo "### ðŸ“Š Reportes Generados" >> $GITHUB_STEP_SUMMARY
            echo "- ðŸŒ [GitHub Pages Dashboard](https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/)" >> $GITHUB_STEP_SUMMARY
            echo "- ðŸ¥’ [Cucumber Reports](https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/reports/${{ steps.params.outputs.env_name }}/cucumber-reports/)" >> $GITHUB_STEP_SUMMARY
            echo "- ðŸ§ª [Surefire Reports](https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/reports/${{ steps.params.outputs.env_name }}/surefire-reports/)" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ðŸš€ Reportes pusheados a la rama \`test-results\` y disponibles en GitHub Pages." >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ No se generaron reportes para esta ejecuciÃ³n" >> $GITHUB_STEP_SUMMARY
          fi

          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "*ðŸ”’ EjecuciÃ³n segura - Credenciales protegidas via GitHub Secrets*" >> $GITHUB_STEP_SUMMARY
          echo "*âš¡ Ejecutado el $(date -u) via webhook \`test-siu01-web\`*" >> $GITHUB_STEP_SUMMARY
          echo "*ðŸ“Š Reportes en rama: \`test-results\`*" >> $GITHUB_STEP_SUMMARY
          echo "*ðŸŒ Dashboard: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/index.html*" >> $GITHUB_STEP_SUMMARY
